ServerRoot "/usr/local/apache2"
ServerName localhost

Listen 80
Listen 443

LoadModule mpm_event_module modules/mod_mpm_event.so
LoadModule unixd_module modules/mod_unixd.so
LoadModule authn_core_module modules/mod_authn_core.so
LoadModule authz_core_module modules/mod_authz_core.so
LoadModule authz_host_module modules/mod_authz_host.so
LoadModule access_compat_module modules/mod_access_compat.so
LoadModule reqtimeout_module modules/mod_reqtimeout.so
LoadModule filter_module modules/mod_filter.so
LoadModule mime_module modules/mod_mime.so
LoadModule log_config_module modules/mod_log_config.so
LoadModule env_module modules/mod_env.so
LoadModule headers_module modules/mod_headers.so
LoadModule setenvif_module modules/mod_setenvif.so
LoadModule ssl_module modules/mod_ssl.so
LoadModule socache_shmcb_module modules/mod_socache_shmcb.so
LoadModule proxy_module modules/mod_proxy.so
LoadModule proxy_fcgi_module modules/mod_proxy_fcgi.so
LoadModule rewrite_module modules/mod_rewrite.so
LoadModule dir_module modules/mod_dir.so
LoadModule alias_module modules/mod_alias.so

User daemon
Group daemon

ServerAdmin you@example.com
DocumentRoot "/var/www/html/public"

<Directory />
    AllowOverride none
    Require all denied
</Directory>

<Directory "/var/www/html/public">
    Options FollowSymLinks
    AllowOverride All
    Require all granted
</Directory>

DirectoryIndex index.php index.html

TypesConfig conf/mime.types
AddType application/x-compress .Z
AddType application/x-gzip .gz .tgz

LogLevel warn
ErrorLog /proc/self/fd/2
CustomLog /proc/self/fd/1 combined

# -----------------------------
# PHP-FPM via mod_proxy_fcgi
# -----------------------------
<FilesMatch "\.php$">
    SetHandler "proxy:fcgi://php:9000"
</FilesMatch>

# Avoid serving ".env" or other hidden files from public (defense-in-depth)
<FilesMatch "^\.">
    Require all denied
</FilesMatch>

# -----------------------------
# HTTP -> HTTPS redirect
# -----------------------------
<VirtualHost *:80>
    ServerName localhost
    RewriteEngine On
    # docker-compose maps host 8000->80 and 8443->443, so force the mapped HTTPS port.
    # Also strip any existing port from HTTP_HOST (e.g. localhost:8000).
    RewriteCond %{HTTP_HOST} ^([^:]+)(:\d+)?$
    RewriteRule ^ https://%1:8443%{REQUEST_URI} [R=301,L]
</VirtualHost>

# -----------------------------
# HTTPS vhost
# -----------------------------
<VirtualHost *:443>
    ServerName localhost
    DocumentRoot "/var/www/html/public"

    SSLEngine on
    SSLCertificateFile "/usr/local/apache2/conf/ssl/server.crt"
    SSLCertificateKeyFile "/usr/local/apache2/conf/ssl/server.key"

    # Reasonable dev defaults
    SSLProtocol all -SSLv3 -TLSv1 -TLSv1.1
    SSLHonorCipherOrder off

    # Enforce HTTPS on the client side (helps satisfy "no unencrypted communication")
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"

    <Directory "/var/www/html/public">
        Options FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>

    ErrorLog /proc/self/fd/2
    CustomLog /proc/self/fd/1 combined
</VirtualHost>
